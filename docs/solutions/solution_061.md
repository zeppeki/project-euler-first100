# Problem 061: Cyclical figurate numbers

## 問題

Triangle, square, pentagonal, hexagonal, heptagonal, and octagonal numbers are all figurate (polygonal) numbers and are generated by the following formulae:

- Triangle: P3,n=n(n+1)/2 (1, 3, 6, 10, 15, ...)
- Square: P4,n=n² (1, 4, 9, 16, 25, ...)
- Pentagonal: P5,n=n(3n-1)/2 (1, 5, 12, 22, 35, ...)
- Hexagonal: P6,n=n(2n-1) (1, 6, 15, 28, 45, ...)
- Heptagonal: P7,n=n(5n-3)/2 (1, 7, 18, 34, 55, ...)
- Octagonal: P8,n=n(3n-2) (1, 8, 21, 40, 65, ...)

The ordered set of three 4-digit numbers: 8128, 2882, 8281, has three interesting properties.

1. The set is cyclic, in that the last two digits of each number is the first two digits of the next number (including the last number with the first).
2. Each polygonal type: triangle (P3,127=8128), square (P4,91=8281), pentagonal (P5,44=2882), is represented by a different number in the set.
3. This is the only set of three 4-digit numbers with this property.

Find the ordered set of six 4-digit numbers for which each polygonal type: triangle, square, pentagonal, hexagonal, heptagonal, and octagonal, is represented by a different number in the set.

## 解答

Project Euler公式サイトで確認してください。

## アプローチ

### 1. 素直な解法 (solve_naive)
- **アルゴリズム**: 全ての可能な組み合わせを総当たりで探索
- **手順**:
  1. 各多角数の4桁の数を全て生成
  2. 6つの数の全順列を生成
  3. 各順列で循環条件をチェック
  4. 条件を満たす組み合わせを返す
- **時間計算量**: O(n!×6×m) - 非常に非効率
- **空間計算量**: O(n×6) - 各多角数の保存

### 2. 最適化解法 (solve_optimized)
- **アルゴリズム**: グラフ探索による効率的な循環検出
- **最適化のポイント**:
  1. **辞書構造**: 下2桁をキーとした辞書で高速検索
  2. **バックトラッキング**: 深さ優先探索で効率的な探索
  3. **早期終了**: 条件を満たさない経路の早期除外
  4. **グラフ表現**: 循環構造をグラフとして表現
- **時間計算量**: O(m×6!) - 大幅な改善
- **空間計算量**: O(m) - 辞書による効率的な保存

## 実装のポイント

### 多角数の生成
```python
def generate_polygonal_numbers(sides, min_val=1000, max_val=9999):
    """指定された辺数の多角数を生成"""
    numbers = []
    n = 1
    while True:
        if sides == 3:  # Triangle
            num = n * (n + 1) // 2
        elif sides == 4:  # Square
            num = n * n
        elif sides == 5:  # Pentagonal
            num = n * (3 * n - 1) // 2
        elif sides == 6:  # Hexagonal
            num = n * (2 * n - 1)
        elif sides == 7:  # Heptagonal
            num = n * (5 * n - 3) // 2
        elif sides == 8:  # Octagonal
            num = n * (3 * n - 2)

        if num > max_val:
            break
        if num >= min_val:
            numbers.append(num)
        n += 1
    return numbers
```

### 循環条件のチェック
```python
def is_cyclic(numbers):
    """数列が循環条件を満たすかチェック"""
    for i in range(len(numbers)):
        current = numbers[i]
        next_num = numbers[(i + 1) % len(numbers)]
        if current % 100 != next_num // 100:
            return False
    return True
```

### グラフ探索による解法
```python
def find_cycle_dfs(graph, used_types, current_path, target_length):
    """深さ優先探索による循環の発見"""
    if len(current_path) == target_length:
        if is_complete_cycle(current_path):
            return current_path
        return None

    for next_num, next_type in graph[current_path[-1] % 100]:
        if next_type not in used_types:
            result = find_cycle_dfs(
                graph,
                used_types | {next_type},
                current_path + [next_num],
                target_length
            )
            if result:
                return result
    return None
```

## 数学的背景

### 多角数の性質
各多角数は特定の公式で生成され、異なる成長率を持ちます：
- **三角数**: 線形成長
- **四角数**: 平方成長
- **五角数以上**: より高次の成長

### 循環構造
循環条件は、隣接する数の下2桁と上2桁の一致を要求します。
これにより、グラフ構造として表現可能になります。

## 学習ポイント

1. **組み合わせ最適化**: 制約条件を活用した探索空間の削減
2. **グラフアルゴリズム**: 循環構造の効率的な探索
3. **バックトラッキング**: 深さ優先探索による解の発見
4. **データ構造**: 辞書による高速な検索の実現
5. **数学的性質**: 多角数の性質と成長パターンの理解

## 検証

- **テストケース**: 3つの数での循環確認（問題例）
- **期待値**: [隠匿]
- **実行時間**: グラフ探索により大幅短縮
- **検証**: ✓

## 参考資料

- [Polygonal number on Wikipedia](https://en.wikipedia.org/wiki/Polygonal_number)
- [Graph algorithms and cycle detection](https://en.wikipedia.org/wiki/Cycle_detection)
