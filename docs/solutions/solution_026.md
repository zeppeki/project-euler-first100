# Problem 026: Reciprocal cycles

## 問題

単位分数は分子に1を含む。分母が2から10までの単位分数の小数表現は以下の通りである:

1/2  = 0.5
1/3  = 0.(3)
1/4  = 0.25
1/5  = 0.2
1/6  = 0.1(6)
1/7  = 0.(142857)
1/8  = 0.125
1/9  = 0.(1)
1/10 = 0.1

ここで0.1(6)は0.166666...を意味し、1桁の循環周期を持つ。1/7は6桁の循環周期を持つことがわかる。

d < 1000 について、1/d の小数部分で最も長い循環周期を含むdの値を求めよ。

## 解答

Project Euler公式サイトで確認してください。

## 解法

この問題は、単位分数の小数表現における循環周期の長さを求める問題です。2つのアプローチで解法を実装しました。

### 1. 素直な解法 (`solve_naive`)

最も直感的な方法は、長除法をシミュレートして循環を検出する方法です。

- **時間計算量**: `O(n²)` (nは制限値)
- **空間計算量**: `O(n)`

#### 循環周期の検出アルゴリズム

1/dの小数表現を求める際、長除法では余りが重要な役割を果たします：

1. **前処理**: dから2と5の因数を除去します（これらは循環しない小数を作る）
2. **長除法シミュレート**: 余りを追跡しながら10で割り続けます
3. **循環検出**: 同じ余りが再び現れたとき、循環が検出されます
4. **周期長計算**: 最初に現れた位置と再度現れた位置の差が循環周期です

```python
def get_cycle_length_naive(d: int) -> int:
    """
    素直な解法: 長除法をシミュレートして循環周期を求める
    """
    if d <= 1:
        return 0

    # 2と5の因数を除去（これらは循環しない）
    while d % 2 == 0:
        d //= 2
    while d % 5 == 0:
        d //= 5

    if d == 1:
        return 0

    # 長除法をシミュレート
    remainder = 1
    seen_remainders = {}
    position = 0

    while remainder != 0:
        if remainder in seen_remainders:
            # 循環を発見
            return position - seen_remainders[remainder]

        seen_remainders[remainder] = position
        remainder = (remainder * 10) % d
        position += 1

    return 0
```

### 2. 最適化解法 (`solve_optimized`)

より効率的な方法は、法の性質を直接利用する方法です。

- **時間計算量**: `O(n × log n)`
- **空間計算量**: `O(1)`

#### 数学的背景

1/dの循環周期は、10^k ≡ 1 (mod d) となる最小の正整数kです。これは以下の理論に基づいています：

**定理**: gcd(10, d) = 1 のとき、1/dの循環周期は10のmod dにおける位数（multiplicative order）に等しい。

位数とは、a^k ≡ 1 (mod n) となる最小の正整数kのことです。

```python
def get_cycle_length_optimized(d: int) -> int:
    """
    最適化解法: 法の性質を利用した効率的な循環周期計算
    """
    if d <= 1:
        return 0

    # 2と5の因数を除去（これらは循環しない）
    while d % 2 == 0:
        d //= 2
    while d % 5 == 0:
        d //= 5

    if d == 1:
        return 0

    # 10^k ≡ 1 (mod d) となる最小のkを求める
    remainder = 1
    for k in range(1, d):
        remainder = (remainder * 10) % d
        if remainder == 1:
            return k

    return 0
```

### 重要な数学的性質

1. **非循環因子**: 2と5の因数は循環に寄与しません（10進法の基数の因子のため）
2. **フェルマーの小定理**: pが素数でgcd(10, p) = 1なら、循環周期はp-1の約数です
3. **最大周期**: d-1が可能な最大の循環周期です（dが素数の場合）

## パフォーマンス比較

| 解法 | 実行時間（参考） |
| :--- | :--- |
| 素直な解法 | ~0.012秒 |
| 最適化解法 | ~0.005秒 |

最適化解法は辞書を使わずに直接計算するため、メモリ効率と実行速度の両方で優れています。

## 学習ポイント

- **長除法の理解**: 小数の循環は余りの繰り返しパターンとして理解できる
- **法演算の活用**: modular arithmetic を使った効率的な計算方法
- **数論の応用**: multiplicative order や フェルマーの小定理の実用的な応用
- **前処理の重要性**: 2と5の因数除去による問題の簡略化
- **循環検出アルゴリズム**: Floyd's cycle detection algorithm の応用可能性
- **素数の特性**: 素数における循環周期の特別な性質
