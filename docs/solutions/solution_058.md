# Problem 058: Spiral primes

## 問題文

1から始めて反時計回りにスパイラル状に数を配置すると、辺の長さ7の正方形スパイラルが形成される。

```
37 36 35 34 33 32 31
38 17 16 15 14 13 30
39 18  5  4  3 12 29
40 19  6  1  2 11 28
41 20  7  8  9 10 27
42 21 22 23 24 25 26
43 44 45 46 47 48 49
```

興味深いことに、奇数の平方数は右下の対角線上に並んでいるが、さらに興味深いのは、両対角線上の13個の数のうち8個が素数であること（比率8/13 ≈ 62%）である。

上記のスパイラルの周りに1つの完全な新しい層を巻くと、辺の長さ9の正方形が形成される。この過程を続けたとき、両対角線上の素数の比率が初めて10%を下回るスパイラルの辺の長さはいくつか？

## アプローチ

### アプローチ 1: 素直な解法 (solve_naive)

**アルゴリズム**:
1. 辺の長さを3から開始（奇数のみ）
2. 各辺の長さについて、すべての対角線の値を計算
3. 素数の数と総数をカウントして比率を計算
4. 比率が目標値を下回る最初の辺の長さを返す

**計算量**:
- 時間計算量: O(n² × √m) (nは辺の長さ、mは対角線上の最大値)
- 空間計算量: O(n)

### アプローチ 2: 最適化解法 (solve_optimized)

**最適化のポイント**:
1. **段階的計算**: 各層の対角線の値を個別に計算
2. **累積カウント**: 素数と総数を累積的に管理
3. **メモリ効率**: 全ての対角線の値を保存せずに必要な情報のみ追跡

**アルゴリズム**:
1. 素数カウントと総数を初期化（中央の1から開始）
2. 各層について対角線の値を計算
3. 新しい素数をカウントして累積値に追加
4. 比率をチェックして条件を満たしたら終了

**計算量**:
- 時間計算量: O(n × √m) (mは対角線上の最大値)
- 空間計算量: O(1)

## 重要な概念

### スパイラルの構造

1. **中央**: 1から開始
2. **層構造**: 辺の長さ3, 5, 7, 9, ...と2ずつ増加
3. **対角線の値**: 各層で4つの新しい対角線の値が追加

### 対角線の値の計算式

辺の長さnのスパイラルにおいて、最外層の対角線の値は：
- **右下**: n²
- **右上**: n² - (n-1)
- **左上**: n² - 2(n-1)
- **左下**: n² - 3(n-1)

### 数学的性質

1. **奇数の平方数**: 右下の対角線は1, 9, 25, 49, 81, ...
2. **等差数列**: 各層の対角線の値は(n-1)の等差数列
3. **素数の分布**: 大きな数ほど素数の密度が低下

## 実装上の注意点

### 効率的な素数判定

1. **基本的な最適化**: 2で割り切れるかチェック後、奇数のみで試し割り
2. **範囲**: √nまでの試し割りで十分
3. **早期終了**: 割り切れた時点で合成数と判定

### パフォーマンス最適化

1. **段階的計算**: 全体を再計算せず、増分のみ処理
2. **メモリ効率**: 大量の数値を保存せず、必要な情報のみ維持
3. **累積管理**: 素数カウントと総数の効率的な追跡

## 学習ポイント

### 数学的洞察

1. **スパイラル構造**: 2次元配列の数学的表現
2. **対角線パターン**: 規則的な数列の性質
3. **素数分布**: 大数における素数の密度変化

### アルゴリズム設計

1. **段階的処理**: 全体計算vs増分計算の比較
2. **累積データ**: 効率的な状態管理
3. **早期終了**: 条件達成時の即座の終了

## 実行例

### 小さなスパイラルの例

```python
# 辺の長さ3のスパイラル
対角線の値: [1, 9, 7, 5, 3]
素数: [7, 5, 3] = 3個
比率: 3/5 = 60%

# 辺の長さ5のスパイラル
対角線の値: [1, 9, 7, 5, 3, 25, 21, 17, 13]
素数: [7, 5, 3, 17, 13] = 5個
比率: 5/9 ≈ 55.6%

# 辺の長さ7のスパイラル (問題の例)
対角線の値: [1, 9, 7, 5, 3, 25, 21, 17, 13, 49, 43, 37, 31]
素数: [7, 5, 3, 17, 13, 43, 37, 31] = 8個
比率: 8/13 ≈ 61.5%
```

### パフォーマンス比較

- **素直な解法**: 各辺の長さで全対角線を再計算
- **最適化解法**: 段階的に新しい層のみ処理
- **メモリ使用量**: 最適化解法はO(1)の空間効率

## 解答

Project Euler公式サイトで確認してください。

## 検証

- **入力**: 目標比率10%
- **解答**: [隠匿]
- **検証**: ✓ 全解法で一致

## 統計情報

### 素数比率の変化

辺の長さが大きくなるにつれて、対角線上の素数の比率は一般的に減少する傾向がある。これは以下の理由による：

1. **素数定理**: 大きな数n周辺の素数密度は約1/ln(n)
2. **対角線の値の成長**: n²に比例して値が大きくなる
3. **素数の稀少性**: 大きな数ほど素数は稀になる

### パターン分析

- **初期値**: 小さなスパイラルでは比較的高い素数比率
- **減少傾向**: 辺の長さの増加とともに比率は減少
- **閾値**: 10%を下回る最初の辺の長さが解答

## 数学的背景

### スパイラルの数列論

スパイラルの対角線は、特定の2次式で表現される数列を形成する：
- **右下**: 奇数の平方数列
- **その他**: 平方数から等差的に減少する数列

### 素数分布理論

1. **素数定理**: π(x) ≈ x/ln(x)
2. **密度の減少**: 大きな数での素数密度の低下
3. **確率的性質**: 素数の出現パターンの統計的性質

### 計算数論的応用

1. **効率的な素数判定**: 試し割り法の最適化
2. **数列の生成**: 規則的なパターンの活用
3. **累積統計**: 効率的なカウント手法

## 参考文献

- **数列論**: 特殊な数列の性質と応用
- **素数論**: 素数分布の理論と実践
- **計算数学**: 効率的なアルゴリズムの設計原理
